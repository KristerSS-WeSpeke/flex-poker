<?xml version="1.0" encoding="utf-8"?>
<mx:Application
    xmlns:mx="http://www.adobe.com/2006/mxml"
    xmlns:comp="components.*"
    currentState="loginState"
    applicationComplete="initApplication()">

    <mx:Script>
    <![CDATA[

        import mx.messaging.ChannelSet;
        import mx.messaging.channels.AMFChannel;
        import mx.controls.Alert;
        import mx.rpc.events.FaultEvent;
        import mx.rpc.events.ResultEvent;
        import mx.rpc.AsyncToken;
        import mx.rpc.AsyncResponder;
        import mx.messaging.messages.AsyncMessage;
        import mx.messaging.messages.IMessage;
        import mx.rpc.remoting.RemoteObject;
        import mx.messaging.messages.IMessage;
        import com.flexpoker.events.LoginAttemptEvent;
        import com.flexpoker.events.SendChatMessageEvent

        public function initApplication():void {
            loginForm.addEventListener(LoginAttemptEvent.NAME, login);
            chatPanel.addEventListener(SendChatMessageEvent.NAME, sendChatMessage);
        }

        var ro1:RemoteObject = createRemoteObject("securedProductService", "c1");   
        var ro2:RemoteObject = createRemoteObject("gameBso", "c2");   

        public static function createRemoteObject(roDestination:String, channelId:String):RemoteObject {   
            var channelSet:ChannelSet = new ChannelSet();   
            var channel:AMFChannel = new AMFChannel(channelId, "http://flexpoker.com/poker/messagebroker/amf");   
            channelSet.addChannel(channel);   
            var ro:RemoteObject = new RemoteObject(roDestination);   
            ro.channelSet = channelSet;   
            return ro;   
        }   

        private function login(event:LoginAttemptEvent):void {
            var token:AsyncToken = ro1.channelSet.login(event.getUsername(), event.getPassword());

            token.addResponder(new AsyncResponder(
                function(event:ResultEvent, token:Object = null):void {
                    currentState = "";
                    consumer.subscribe();
                    gameGridConsumer.subscribe();
                },
                function(event:FaultEvent, token:Object = null):void {
                    Alert.show("Login Failed: " + event.fault.faultString);
                }
            ))
        }

        private function sendChatMessage(event:SendChatMessageEvent):void {
            var message:IMessage = new AsyncMessage();
            message.body.userId = loginForm.userId.text;
            message.body.chatMessage = event.getMessageText();
            producer.send(message);
            chatPanel.message.text = "";
        }

        private function messageHandler(message:IMessage):void {
            chatPanel.log.text += message.body.userId + ": " + message.body.chatMessage + "\n";
        }

        private function gamePushHandler(message:IMessage):void {
            ro2.fetchAllGames();
        }

    ]]>
    </mx:Script>

    <mx:states>
        <mx:State name="loginState">
            <mx:RemoveChild target="{mainApp}" />
            <mx:AddChild position="lastChild">
                <comp:LoginForm id="loginForm" />    
            </mx:AddChild>
        </mx:State>
    </mx:states>

    <mx:ChannelSet id="cs">
        <mx:AMFChannel url="http://flexpoker.com/poker/messagebroker/amflongpolling"/>
        <mx:AMFChannel url="http://flexpoker.com/poker/messagebroker/amfpolling"/>
    </mx:ChannelSet>
    
    <mx:Producer id="producer" destination="jms-chat" channelSet="{cs}"/>
    <mx:Consumer id="consumer" destination="jms-chat" channelSet="{cs}" message="messageHandler(event.message)"/>
    
    <mx:Consumer id="gameGridConsumer" destination="gamesUpdated" channelSet="{cs}" message="gamePushHandler(event.message)"/>

    <mx:VBox id="mainApp" height="100%" width="100%">
    <mx:LinkBar x="115.5" y="43" dataProvider="myViewStack" borderStyle="inset" />
    <mx:ViewStack x="10" y="99" id="myViewStack">
        <mx:Canvas label="Home" width="100%" height="100%" borderStyle="inset">
            <mx:Text x="10" y="10" text="Games" width="449" height="180"/>
            <mx:DataGrid dataProvider="{ro2.fetchAllGames.lastResult}" width="100%" height="100%"/>
            <mx:Button label="Create Game" click="ro2.createGame()"/>
        </mx:Canvas>
        <mx:Canvas label="Portfolio" width="100%" height="100%" borderStyle="inset">
            <mx:Text x="10" y="10" text="Portfolio page" width="449" height="180"/>
        </mx:Canvas>
        <mx:Canvas label="About" width="100%" height="100%" borderStyle="inset">
            <mx:Text x="10" y="10" text="About page" width="449" height="180"/>
        </mx:Canvas>
        <mx:Canvas label="Contact" width="100%" height="100%" borderStyle="inset">
            <mx:Text x="10" y="10" text="Contact page" width="449" height="180"/>
        </mx:Canvas>
    </mx:ViewStack>

    <comp:ChatPanel id="chatPanel" height="100%" width="100%" />
    
    </mx:VBox>

</mx:Application>
