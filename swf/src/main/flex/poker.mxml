<?xml version="1.0" encoding="utf-8"?>
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml" currentState="loginState">

	<mx:Script>
		<![CDATA[

			import mx.messaging.ChannelSet;
			import mx.messaging.channels.AMFChannel;
			import mx.controls.Alert;
			import mx.rpc.events.FaultEvent;
            import mx.rpc.events.ResultEvent;
            import mx.rpc.AsyncToken;
            import mx.rpc.AsyncResponder;
            import mx.messaging.messages.AsyncMessage;
            import mx.messaging.messages.IMessage;
            import mx.rpc.remoting.RemoteObject;
			
            var ro1:RemoteObject = createRemoteObject("securedProductService", "c1");   
            var ro2:RemoteObject = createRemoteObject("gameBso", "c2");   
  
            public static function createRemoteObject(roDestination:String, channelId:String):RemoteObject {   
                var channelSet:ChannelSet = new ChannelSet();   
                var channel:AMFChannel = new AMFChannel(channelId, "http://flexpoker.com/poker/messagebroker/amf");   
                channelSet.addChannel(channel);   
                var ro:RemoteObject = new RemoteObject(roDestination);   
                ro.channelSet = channelSet;   
                return ro;   
            }   

			private function faultHandler(event:FaultEvent):void
			{
				Alert.show(event.fault.faultString, "Error ccessing RemoteObject");
			}
			
            private function resultHandler(event:ResultEvent):void
            {
                Alert.show("Success!");
            }
            
			private function login():void
			{
				var token:AsyncToken = ro1.channelSet.login(userId.text, password.text);
                token.addResponder(new AsyncResponder(
                    function(event:ResultEvent, token:Object = null):void {
                        currentState = "";
                        consumer.subscribe();
                    },
                    function(event:FaultEvent, token:Object = null):void {
                        Alert.show("Login Failed: " + event.fault.faultString);
                    }
                ))
            }

            private function send():void
            {
                var message:IMessage = new AsyncMessage();
                message.body.userId = userId.text;
                message.body.chatMessage = msg.text;
                producer.send(message);
                msg.text = "";
            }
                            
            private function messageHandler(message:IMessage):void
            {
                log.text += message.body.userId + ": " + message.body.chatMessage + "\n";
            }
		]]>
	</mx:Script>

    <mx:states>
        <mx:State name="loginState">
            <mx:RemoveChild target="{mainApp}" />
            <mx:AddChild position="lastChild">
                <mx:Form defaultButton="{loginButton}">
                    <mx:FormItem label="User Id">
                        <mx:TextInput id="userId" />
                    </mx:FormItem>
                    <mx:FormItem label="Password">
                        <mx:TextInput id="password"
                            displayAsPassword="true" />
                    </mx:FormItem>
                    <mx:FormItem direction="horizontal">
                        <mx:Button id="loginButton" label="Login" click="login()" />
                    </mx:FormItem>
                </mx:Form>
            </mx:AddChild>
        </mx:State>
    </mx:states>

    <mx:ChannelSet id="cs">
        <!-- <mx:StreamingAMFChannel url="http://flexpoker.com/poker/messagebroker/streamingamf"/> -->
        <mx:AMFChannel url="http://flexpoker.com/poker/messagebroker/amflongpolling"/>
        <mx:AMFChannel url="http://flexpoker.com/poker/messagebroker/amfpolling"/>
    </mx:ChannelSet>
    
    <mx:Producer id="producer" destination="jms-chat" channelSet="{cs}"/>
    <mx:Consumer id="consumer" destination="jms-chat" channelSet="{cs}" message="messageHandler(event.message)"/>
    


    <mx:VBox id="mainApp" height="100%" width="100%">
    <mx:LinkBar x="115.5" y="43" dataProvider="myViewStack" borderStyle="inset" />
    <mx:ViewStack x="10" y="99" id="myViewStack">
        <mx:Canvas label="Home" width="100%" height="100%" borderStyle="inset">
            <mx:Text x="10" y="10" text="Home page" width="449" height="180"/>
        </mx:Canvas>
        <mx:Canvas label="Portfolio" width="100%" height="100%" borderStyle="inset">
            <mx:Text x="10" y="10" text="Portfolio page" width="449" height="180"/>
        </mx:Canvas>
        <mx:Canvas label="About" width="100%" height="100%" borderStyle="inset">
            <mx:Text x="10" y="10" text="About page" width="449" height="180"/>
        </mx:Canvas>
        <mx:Canvas label="Contact" width="100%" height="100%" borderStyle="inset">
            <mx:Text x="10" y="10" text="Contact page" width="449" height="180"/>
        </mx:Canvas>
    </mx:ViewStack>

    <mx:Panel title="JMS Chat" width="30%" height="30%">
        <mx:TextArea id="log" width="100%" height="100%" />
        <mx:ControlBar>
            <mx:Form paddingTop="4" paddingBottom="4" paddingLeft="4" paddingRight="4">
                <mx:FormItem label="Message:" direction="horizontal">
                    <mx:TextInput id="msg" enter="send()"/>
                    <mx:Button label="Send" click="send()"/> 
                </mx:FormItem>              
            </mx:Form>
        </mx:ControlBar>
    </mx:Panel>
    
    <mx:DataGrid dataProvider="{ro2.fetchAllGames.lastResult}" width="100%" height="100%"/>

    <mx:Button label="Get Data" click="ro2.fetchAllGames()"/>

    </mx:VBox>
</mx:Application>
