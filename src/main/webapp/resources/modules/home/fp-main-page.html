<template id="fp-main-page">
    <style>

    </style>

    <div>
        <button id="create-game-button">Create Game</button>
        <fp-gamelist></fp-gamelist>
        <fp-chat class="global-chat"></fp-chat>
        <fp-create-game-dialog></fp-create-game-dialog>
        <fp-join-game-dialog></fp-join-game-dialog>
    </div>

</template>

<script>
    'use strict';

    (function() {
        let localDocument = document.currentScript.ownerDocument;
        let element = Object.create(HTMLElement.prototype);

        element.createdCallback = function() {
            let template = localDocument.querySelector('#fp-main-page').content;
            let templateNode = document.importNode(template, true);

            System.import('/resources/modules/common/webSocketService.js').then(m => {
                m.default.registerSubscription('/topic/chat/global/user', displayChat.bind(this));
                m.default.registerSubscription('/topic/chat/global/system', displayChat.bind(this));

                m.default.registerSubscription('/topic/availabletournaments', message => {
                    this.shadowRoot.querySelector('fp-gamelist').displayGames(JSON.parse(message.body));
                });
            });

            templateNode.querySelector('#create-game-button').addEventListener('click', evt => {
                this.shadowRoot.querySelector('fp-create-game-dialog').showDialog();
            });

            templateNode.querySelector('.global-chat').addEventListener('chat-msg-entered', evt => {
                const globalMessage = {
                    message: evt.detail,
                    receiverUsernames: null,
                    gameId: null,
                    tableId: null
                };

                System.import('/resources/modules/common/webSocketService.js').then(m => m.default.send('/app/sendchatmessage', globalMessage));
            });

            templateNode.querySelector('fp-gamelist').addEventListener('game-open-selected', evt => {
                const gameId = evt.detail;
                window.tryingToJoinGameId = gameId;
                this.shadowRoot.querySelector('fp-join-game-dialog').showDialog(gameId);
            });

            templateNode.querySelector('fp-create-game-dialog').addEventListener('create-game-submitted', evt => {
                System.import('/resources/modules/common/webSocketService.js').then(m => m.default.send('/app/creategame', evt.detail));
            });

            templateNode.querySelector('fp-join-game-dialog').addEventListener('join-game-submitted', evt => {
                System.import('/resources/modules/common/webSocketService.js').then(m => m.default.send('/app/joingame', evt.detail));
            });

            this.createShadowRoot().appendChild(templateNode);
        };

        function displayChat(message) {
            this.shadowRoot.querySelector('fp-chat').displayChat(message.body);
        }

        document.registerElement('fp-main-page', {
            prototype: element
        });
    })();
</script>
