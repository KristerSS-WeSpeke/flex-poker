<template id="game-page">
    <style>
    </style>

    <div>
        <p id="gameId"></p>
        <fp-chat class="game-chat"></fp-chat>
    </div>
</template>

<script>
'use strict';

(function() {
    let localDocument = document.currentScript.ownerDocument;
    let element = Object.create(HTMLElement.prototype);

    element.createdCallback = function() {
        let template = localDocument.querySelector('#game-page').content;
        let templateNode = document.importNode(template, true);
        this.createShadowRoot().appendChild(templateNode);
    };

    element.attributeChangedCallback = function(attrName, oldValue, newValue) {
        if (attrName === 'gameid') {
            let gameId = newValue;
            this.shadowRoot.querySelector('#gameId').innerHTML = gameId;

            let self = this;
            let displayChat = function(message) {
                self.shadowRoot.querySelector('fp-chat').displayChat(message.body);
            };

            System.import('/resources/scripts/webSocketService.js').then(m => {
                m.default.registerSubscription(`/topic/chat/game/${gameId}/user`, displayChat);
                m.default.registerSubscription(`/topic/chat/game/${gameId}/system`, displayChat);
            });

            this.shadowRoot.querySelector('.game-chat').addEventListener('chat-msg-entered', function(evt) {
                sendChat(evt.detail, gameId);
            });
        }
    };

    function sendChat(message, gameId) {
        let gameMessage = {
            message: message,
            receiverUsernames: null,
            gameId: gameId,
            tableId: null
        };

        System.import('/resources/scripts/webSocketService.js').then(m => {
            m.default.send('/app/sendchatmessage', gameMessage);
        });
    }

    document.registerElement('game-page', {
        prototype: element
    });
})();
</script>
